name: 构建 OpenList Magisk 模块 (All-in-One)

on:
  schedule:
    - cron: '0 */4 * * *'  # 每4小时运行一次
  workflow_dispatch:  # 支持手动触发
  push:
    branches:
      - main

permissions:
  contents: write
  actions: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: 检出仓库代码
        uses: actions/checkout@v4

      - name: 安装依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y curl zip gh jq

      # ----------------------------------------------------------------
      # 1. 获取 OpenList (核心)
      # ----------------------------------------------------------------
      - name: 获取 OpenList 最新版本
        id: openlist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASE_JSON=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" "https://api.github.com/repos/OpenListTeam/OpenList/releases/latest")
          
          VERSION=$(echo "$RELEASE_JSON" | jq -r .tag_name)
          VERSION_CODE=$(echo "$VERSION" | tr -d 'v' | tr -d '.' | awk '{printf "%d%02d", $1, $2}')
          
          ARM_URL=$(echo "$RELEASE_JSON" | jq -r '.assets[] | select(.name | contains("openlist-android-arm.tar.gz")) | .browser_download_url')
          ARM64_URL=$(echo "$RELEASE_JSON" | jq -r '.assets[] | select(.name | contains("openlist-android-arm64.tar.gz")) | .browser_download_url')
          
          echo "OPENLIST_VERSION=$VERSION" >> $GITHUB_ENV
          echo "OPENLIST_VERSION_CODE=$VERSION_CODE" >> $GITHUB_ENV
          echo "OPENLIST_ARM_URL=$ARM_URL" >> $GITHUB_ENV
          echo "OPENLIST_ARM64_URL=$ARM64_URL" >> $GITHUB_ENV
          echo "OPENLIST_CHANGELOG=$(echo "$RELEASE_JSON" | jq -r .body | head -n 20 | tr -d '\n' | tr -d '\r')" >> $GITHUB_ENV

      # ----------------------------------------------------------------
      # 2. 获取 Aria2
      # ----------------------------------------------------------------
      - name: 获取 Aria2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASE_JSON=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" "https://api.github.com/repos/q3aql/aria2-static-builds/releases/latest")
          ARIA2_VERSION=$(echo "$RELEASE_JSON" | jq -r .tag_name)
          ARIA2_URL=$(echo "$RELEASE_JSON" | jq -r '.assets[] | select(.name | contains("android-arm64")) | .browser_download_url')
          
          echo "ARIA2_VERSION=$ARIA2_VERSION" >> $GITHUB_ENV
          echo "ARIA2_URL=$ARIA2_URL" >> $GITHUB_ENV

      # ----------------------------------------------------------------
      # 3. 获取 Qbittorrent
      # ----------------------------------------------------------------
      - name: 获取 Qbittorrent
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASE_JSON=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" "https://api.github.com/repos/userdocs/qbittorrent-nox-static/releases/latest")
          QBIT_VERSION=$(echo "$RELEASE_JSON" | jq -r .tag_name)
          QBIT_URL=$(echo "$RELEASE_JSON" | jq -r '.assets[] | select(.name == "aarch64-qbittorrent-nox") | .browser_download_url')
          
          echo "QBIT_VERSION=$QBIT_VERSION" >> $GITHUB_ENV
          echo "QBIT_URL=$QBIT_URL" >> $GITHUB_ENV

      # ----------------------------------------------------------------
      # 4. 获取 Frpc
      # ----------------------------------------------------------------
      - name: 获取 Frpc
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASE_JSON=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" "https://api.github.com/repos/fatedier/frp/releases/latest")
          FRPC_VERSION=$(echo "$RELEASE_JSON" | jq -r .tag_name)
          FRPC_URL=$(echo "$RELEASE_JSON" | jq -r '.assets[] | select(.name | contains("linux_arm64.tar.gz")) | .browser_download_url')
          
          echo "FRPC_VERSION=$FRPC_VERSION" >> $GITHUB_ENV
          echo "FRPC_URL=$FRPC_URL" >> $GITHUB_ENV

      # ----------------------------------------------------------------
      # 5. 获取 Rclone
      # ----------------------------------------------------------------
      - name: 获取 Rclone
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASE_JSON=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" "https://api.github.com/repos/rclone/rclone/releases/latest")
          RCLONE_VERSION=$(echo "$RELEASE_JSON" | jq -r .tag_name)
          RCLONE_URL=$(echo "$RELEASE_JSON" | jq -r '.assets[] | select(.name | test("rclone-v.*-linux-arm64.zip")) | .browser_download_url')
          
          echo "RCLONE_VERSION=$RCLONE_VERSION" >> $GITHUB_ENV
          echo "RCLONE_URL=$RCLONE_URL" >> $GITHUB_ENV

      # ----------------------------------------------------------------
      # 6. 获取 AriaNg
      # ----------------------------------------------------------------
      - name: 获取 AriaNg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASE_JSON=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" "https://api.github.com/repos/mayswind/AriaNg/releases/latest")
          ARIANG_VERSION=$(echo "$RELEASE_JSON" | jq -r .tag_name)
          ARIANG_URL=$(echo "$RELEASE_JSON" | jq -r '.assets[] | select(.name | contains("AllInOne.zip")) | .browser_download_url')
          
          echo "ARIANG_VERSION=$ARIANG_VERSION" >> $GITHUB_ENV
          echo "ARIANG_URL=$ARIANG_URL" >> $GITHUB_ENV

      # ----------------------------------------------------------------
      # 7. 获取 VueTorrent
      # ----------------------------------------------------------------
      - name: 获取 VueTorrent
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASE_JSON=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" "https://api.github.com/repos/VueTorrent/VueTorrent/releases/latest")
          VUETORRENT_VERSION=$(echo "$RELEASE_JSON" | jq -r .tag_name)
          VUETORRENT_URL=$(echo "$RELEASE_JSON" | jq -r '.assets[] | select(.name | contains("vuetorrent.zip")) | .browser_download_url')
          
          echo "VUETORRENT_VERSION=$VUETORRENT_VERSION" >> $GITHUB_ENV
          echo "VUETORRENT_URL=$VUETORRENT_URL" >> $GITHUB_ENV

      # ----------------------------------------------------------------
      # 检查版本与构建逻辑 (核心修改)
      # ----------------------------------------------------------------
      - name: 检查当前模块版本
        id: check_version
        run: |
          if [ -f update.json ]; then
            # 读取所有组件的旧版本，如果不存在字段则返回 "none"
            echo "CURRENT_OPENLIST=$(jq -r '.version // "none"' update.json)" >> $GITHUB_ENV
            echo "CURRENT_ARIA2=$(jq -r '.aria2_version // "none"' update.json)" >> $GITHUB_ENV
            echo "CURRENT_QBIT=$(jq -r '.qbit_version // "none"' update.json)" >> $GITHUB_ENV
            echo "CURRENT_FRPC=$(jq -r '.frpc_version // "none"' update.json)" >> $GITHUB_ENV
            echo "CURRENT_RCLONE=$(jq -r '.rclone_version // "none"' update.json)" >> $GITHUB_ENV
            echo "CURRENT_ARIANG=$(jq -r '.ariang_version // "none"' update.json)" >> $GITHUB_ENV
            echo "CURRENT_VUETORRENT=$(jq -r '.vuetorrent_version // "none"' update.json)" >> $GITHUB_ENV
          else
            echo "CURRENT_OPENLIST=none" >> $GITHUB_ENV
            echo "CURRENT_ARIA2=none" >> $GITHUB_ENV
            echo "CURRENT_QBIT=none" >> $GITHUB_ENV
            echo "CURRENT_FRPC=none" >> $GITHUB_ENV
            echo "CURRENT_RCLONE=none" >> $GITHUB_ENV
            echo "CURRENT_ARIANG=none" >> $GITHUB_ENV
            echo "CURRENT_VUETORRENT=none" >> $GITHUB_ENV
          fi

      - name: 检查是否需要构建
        id: should_build
        run: |
          echo "检查版本更新..."
          echo "OpenList: ${{ env.CURRENT_OPENLIST }} -> ${{ env.OPENLIST_VERSION }}"
          echo "Aria2: ${{ env.CURRENT_ARIA2 }} -> ${{ env.ARIA2_VERSION }}"
          echo "Qbittorrent: ${{ env.CURRENT_QBIT }} -> ${{ env.QBIT_VERSION }}"
          
          # 只要有一个组件版本不一致，或者手动触发，就构建
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] || \
             [ "${{ env.OPENLIST_VERSION }}" != "${{ env.CURRENT_OPENLIST }}" ] || \
             [ "${{ env.ARIA2_VERSION }}" != "${{ env.CURRENT_ARIA2 }}" ] || \
             [ "${{ env.QBIT_VERSION }}" != "${{ env.CURRENT_QBIT }}" ] || \
             [ "${{ env.FRPC_VERSION }}" != "${{ env.CURRENT_FRPC }}" ] || \
             [ "${{ env.RCLONE_VERSION }}" != "${{ env.CURRENT_RCLONE }}" ] || \
             [ "${{ env.ARIANG_VERSION }}" != "${{ env.CURRENT_ARIANG }}" ] || \
             [ "${{ env.VUETORRENT_VERSION }}" != "${{ env.CURRENT_VUETORRENT }}" ]; then
             
            echo "检测到组件更新或手动触发，准备构建..."
            echo "SHOULD_BUILD=true" >> $GITHUB_ENV
          else
            echo "所有组件均为最新，无需构建。"
            echo "SHOULD_BUILD=false" >> $GITHUB_ENV
          fi

      # ----------------------------------------------------------------
      # 下载与组装
      # ----------------------------------------------------------------
      - name: 下载并组装文件
        if: env.SHOULD_BUILD == 'true'
        run: |
          mkdir -p OpenList-Magisk/bin
          mkdir -p OpenList-Magisk/web/ariang
          mkdir -p OpenList-Magisk/web/vuetorrent
          
          # OpenList
          curl -L -o openlist-arm.tar.gz "${{ env.OPENLIST_ARM_URL }}"
          tar -xzf openlist-arm.tar.gz
          mv openlist OpenList-Magisk/openlist-arm
          curl -L -o openlist-arm64.tar.gz "${{ env.OPENLIST_ARM64_URL }}"
          tar -xzf openlist-arm64.tar.gz
          mv openlist OpenList-Magisk/openlist-arm64

          # Aria2
          curl -L -o aria2.tar.gz "${{ env.ARIA2_URL }}"
          tar -xzf aria2.tar.gz
          find . -name "aria2c" -type f -exec mv {} OpenList-Magisk/bin/aria2c \;
          
          # Qbittorrent
          curl -L -o OpenList-Magisk/bin/qbittorrent-nox "${{ env.QBIT_URL }}"
          
          # Frpc
          curl -L -o frp.tar.gz "${{ env.FRPC_URL }}"
          tar -xzf frp.tar.gz
          find . -name "frpc" -type f -exec mv {} OpenList-Magisk/bin/frpc \;
          
          # Rclone
          curl -L -o rclone.zip "${{ env.RCLONE_URL }}"
          unzip -o rclone.zip -d rclone_tmp
          find rclone_tmp -name "rclone" -type f -exec mv {} OpenList-Magisk/bin/rclone \;
          
          # AriaNg
          curl -L -o ariang.zip "${{ env.ARIANG_URL }}"
          unzip -o ariang.zip -d OpenList-Magisk/web/ariang
          
          # VueTorrent
          curl -L -o vuetorrent.zip "${{ env.VUETORRENT_URL }}"
          unzip -o vuetorrent.zip -d OpenList-Magisk/web/vuetorrent
          if [ -d "OpenList-Magisk/web/vuetorrent/vuetorrent" ]; then
            mv OpenList-Magisk/web/vuetorrent/vuetorrent/* OpenList-Magisk/web/vuetorrent/
            rmdir OpenList-Magisk/web/vuetorrent/vuetorrent
          fi

          chmod 755 OpenList-Magisk/openlist-*
          chmod 755 OpenList-Magisk/bin/*
          rm -rf *.tar.gz *.zip rclone_tmp

      # ----------------------------------------------------------------
      # 更新配置与发布 (核心修改)
      # ----------------------------------------------------------------
      - name: 更新配置文件
        if: env.SHOULD_BUILD == 'true'
        run: |
          # 更新 update.json，写入所有组件版本
          cat > update.json << EOF
          {
              "version": "${{ env.OPENLIST_VERSION }}",
              "versionCode": ${{ env.OPENLIST_VERSION_CODE }},
              "zipUrl": "${{ github.server_url }}/${{ github.repository }}/releases/download/${{ env.OPENLIST_VERSION }}/openlist-magisk-${{ env.OPENLIST_VERSION }}.zip",
              "changelog": "${{ github.server_url }}/${{ github.repository }}/raw/main/OpenList-Magisk/CHANGELOG.md",
              "aria2_version": "${{ env.ARIA2_VERSION }}",
              "qbit_version": "${{ env.QBIT_VERSION }}",
              "frpc_version": "${{ env.FRPC_VERSION }}",
              "rclone_version": "${{ env.RCLONE_VERSION }}",
              "ariang_version": "${{ env.ARIANG_VERSION }}",
              "vuetorrent_version": "${{ env.VUETORRENT_VERSION }}"
          }
          EOF

          # 更新 module.prop
          if [ -f OpenList-Magisk/module.prop ]; then
            sed -i "s/^version=.*/version=${{ env.OPENLIST_VERSION }} (All-in-One)/" OpenList-Magisk/module.prop
            sed -i "s/^versionCode=.*/versionCode=${{ env.OPENLIST_VERSION_CODE }}/" OpenList-Magisk/module.prop
          else
            echo "::error::module.prop 文件不存在"
            exit 1
          fi

          # 提交更改
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add update.json OpenList-Magisk/module.prop
          git commit -m "Update: OpenList ${{ env.OPENLIST_VERSION }}, Aria2 ${{ env.ARIA2_VERSION }}, Qbit ${{ env.QBIT_VERSION }}..." || echo "无更改需要提交"
          git push origin main

      - name: 打包模块
        if: env.SHOULD_BUILD == 'true'
        run: |
          cd OpenList-Magisk
          zip -r ../openlist-magisk-${{ env.OPENLIST_VERSION }}.zip .
          cd ..

      - name: 创建 Release
        if: env.SHOULD_BUILD == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ env.OPENLIST_VERSION }}" \
            --title "OpenList Magisk Module ${{ env.OPENLIST_VERSION }} (All-in-One)" \
            --notes "Synced with OpenList v${{ env.OPENLIST_VERSION }}. Includes Aria2 ${{ env.ARIA2_VERSION }}, Qbittorrent ${{ env.QBIT_VERSION }}, etc." \
            --draft=false \
            --prerelease=false \
            "openlist-magisk-${{ env.OPENLIST_VERSION }}.zip"

      - name: 清理临时文件
        if: always()
        run: |
          rm -rf openlist-magisk-*.zip
