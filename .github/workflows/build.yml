name: æž„å»º OpenList Magisk æ¨¡å— (All-in-One)

on:
  schedule:
    - cron: '0 18 * * 6'  # åŒ—äº¬æ—¶é—´å‘¨æ—¥å‡Œæ™¨2ç‚¹ (UTCå‘¨å…­18ç‚¹)
  workflow_dispatch:
    inputs:
      force_build:
        description: 'å¼ºåˆ¶æž„å»ºï¼ˆå¿½ç•¥ç‰ˆæœ¬æ£€æŸ¥ï¼‰'
        required: false
        default: 'false'
        type: boolean
  push:
    branches:
      - main
    paths:
      - 'OpenList-Magisk/**'
      - '.github/workflows/**'

permissions:
  contents: write
  actions: read

env:
  MODULE_ID: "openlist"
  MODULE_NAME: "OpenList All-in-One"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: å®‰è£…ä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y curl zip gh jq

      # ================================================================
      # ç¬¬ä¸€é˜¶æ®µï¼šèŽ·å–æ‰€æœ‰ç»„ä»¶çš„æœ€æ–°ç‰ˆæœ¬
      # ================================================================
      
      - name: èŽ·å– OpenList æœ€æ–°ç‰ˆæœ¬
        id: openlist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "::group::èŽ·å– OpenList ç‰ˆæœ¬ä¿¡æ¯"
          RELEASE_JSON=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
            "https://api.github.com/repos/OpenListTeam/OpenList/releases/latest")
          
          VERSION=$(echo "$RELEASE_JSON" | jq -r '.tag_name // empty')
          if [ -z "$VERSION" ]; then
            echo "::error::æ— æ³•èŽ·å– OpenList ç‰ˆæœ¬"
            exit 1
          fi
          
          VERSION_CODE=$(echo "$VERSION" | tr -d 'v' | awk -F. '{printf "%d%02d%02d", $1, $2, $3}')
          
          ARM_URL=$(echo "$RELEASE_JSON" | jq -r '.assets[] | select(.name | contains("openlist-android-arm.tar.gz")) | .browser_download_url')
          ARM64_URL=$(echo "$RELEASE_JSON" | jq -r '.assets[] | select(.name | contains("openlist-android-arm64.tar.gz")) | .browser_download_url')
          
          echo "OpenList ç‰ˆæœ¬: $VERSION (Code: $VERSION_CODE)"
          echo "ARM URL: $ARM_URL"
          echo "ARM64 URL: $ARM64_URL"
          
          echo "OPENLIST_VERSION=$VERSION" >> $GITHUB_ENV
          echo "OPENLIST_VERSION_CODE=$VERSION_CODE" >> $GITHUB_ENV
          echo "OPENLIST_ARM_URL=$ARM_URL" >> $GITHUB_ENV
          echo "OPENLIST_ARM64_URL=$ARM64_URL" >> $GITHUB_ENV
          echo "::endgroup::"

      - name: èŽ·å– Aria2 æœ€æ–°ç‰ˆæœ¬
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "::group::èŽ·å– Aria2 ç‰ˆæœ¬ä¿¡æ¯"
          RELEASE_JSON=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
            "https://api.github.com/repos/P3TERX/Aria2-Pro-Core/releases/latest")
          
          ARIA2_VERSION=$(echo "$RELEASE_JSON" | jq -r '.tag_name // "unknown"')
          ARIA2_URL=$(echo "$RELEASE_JSON" | jq -r '.assets[] | select(.name | endswith("linux-arm64.tar.gz")) | .browser_download_url')
          
          echo "Aria2 ç‰ˆæœ¬: $ARIA2_VERSION"
          echo "ARIA2_VERSION=$ARIA2_VERSION" >> $GITHUB_ENV
          echo "ARIA2_URL=$ARIA2_URL" >> $GITHUB_ENV
          echo "::endgroup::"

      - name: èŽ·å– Qbittorrent æœ€æ–°ç‰ˆæœ¬
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "::group::èŽ·å– Qbittorrent ç‰ˆæœ¬ä¿¡æ¯"
          RELEASE_JSON=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
            "https://api.github.com/repos/userdocs/qbittorrent-nox-static/releases/latest")
          
          QBIT_VERSION=$(echo "$RELEASE_JSON" | jq -r '.tag_name // "unknown"')
          QBIT_URL=$(echo "$RELEASE_JSON" | jq -r '.assets[] | select(.name == "aarch64-qbittorrent-nox") | .browser_download_url')
          
          echo "Qbittorrent ç‰ˆæœ¬: $QBIT_VERSION"
          echo "QBIT_VERSION=$QBIT_VERSION" >> $GITHUB_ENV
          echo "QBIT_URL=$QBIT_URL" >> $GITHUB_ENV
          echo "::endgroup::"

      - name: èŽ·å– Frpc æœ€æ–°ç‰ˆæœ¬
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "::group::èŽ·å– Frpc ç‰ˆæœ¬ä¿¡æ¯"
          RELEASE_JSON=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
            "https://api.github.com/repos/fatedier/frp/releases/latest")
          
          FRPC_VERSION=$(echo "$RELEASE_JSON" | jq -r '.tag_name // "unknown"')
          FRPC_URL=$(echo "$RELEASE_JSON" | jq -r '.assets[] | select(.name | contains("linux_arm64.tar.gz")) | .browser_download_url')
          
          echo "Frpc ç‰ˆæœ¬: $FRPC_VERSION"
          echo "FRPC_VERSION=$FRPC_VERSION" >> $GITHUB_ENV
          echo "FRPC_URL=$FRPC_URL" >> $GITHUB_ENV
          echo "::endgroup::"

      - name: èŽ·å– Rclone æœ€æ–°ç‰ˆæœ¬
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "::group::èŽ·å– Rclone ç‰ˆæœ¬ä¿¡æ¯"
          RELEASE_JSON=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
            "https://api.github.com/repos/rclone/rclone/releases/latest")
          
          RCLONE_VERSION=$(echo "$RELEASE_JSON" | jq -r '.tag_name // "unknown"')
          RCLONE_URL=$(echo "$RELEASE_JSON" | jq -r '.assets[] | select(.name | test("rclone-v.*-linux-arm64.zip")) | .browser_download_url')
          
          echo "Rclone ç‰ˆæœ¬: $RCLONE_VERSION"
          echo "RCLONE_VERSION=$RCLONE_VERSION" >> $GITHUB_ENV
          echo "RCLONE_URL=$RCLONE_URL" >> $GITHUB_ENV
          echo "::endgroup::"

      - name: èŽ·å– AriaNg æœ€æ–°ç‰ˆæœ¬
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "::group::èŽ·å– AriaNg ç‰ˆæœ¬ä¿¡æ¯"
          RELEASE_JSON=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
            "https://api.github.com/repos/mayswind/AriaNg/releases/latest")
          
          ARIANG_VERSION=$(echo "$RELEASE_JSON" | jq -r '.tag_name // "unknown"')
          ARIANG_URL=$(echo "$RELEASE_JSON" | jq -r '.assets[] | select(.name | contains("AllInOne.zip")) | .browser_download_url')
          
          echo "AriaNg ç‰ˆæœ¬: $ARIANG_VERSION"
          echo "ARIANG_VERSION=$ARIANG_VERSION" >> $GITHUB_ENV
          echo "ARIANG_URL=$ARIANG_URL" >> $GITHUB_ENV
          echo "::endgroup::"

      - name: èŽ·å– VueTorrent æœ€æ–°ç‰ˆæœ¬
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "::group::èŽ·å– VueTorrent ç‰ˆæœ¬ä¿¡æ¯"
          RELEASE_JSON=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
            "https://api.github.com/repos/VueTorrent/VueTorrent/releases/latest")
          
          VUETORRENT_VERSION=$(echo "$RELEASE_JSON" | jq -r '.tag_name // "unknown"')
          VUETORRENT_URL=$(echo "$RELEASE_JSON" | jq -r '.assets[] | select(.name | contains("vuetorrent.zip")) | .browser_download_url')
          
          echo "VueTorrent ç‰ˆæœ¬: $VUETORRENT_VERSION"
          echo "VUETORRENT_VERSION=$VUETORRENT_VERSION" >> $GITHUB_ENV
          echo "VUETORRENT_URL=$VUETORRENT_URL" >> $GITHUB_ENV
          echo "::endgroup::"

      # ================================================================
      # ç¬¬äºŒé˜¶æ®µï¼šç‰ˆæœ¬æ£€æŸ¥ä¸Žæž„å»ºå†³ç­–
      # ================================================================
      
      - name: è¯»å–å½“å‰å·²å‘å¸ƒç‰ˆæœ¬
        id: check_version
        run: |
          echo "::group::è¯»å– update.json ä¸­çš„ç‰ˆæœ¬ä¿¡æ¯"
          if [ -f update.json ]; then
            echo "CURRENT_OPENLIST=$(jq -r '.version // "none"' update.json)" >> $GITHUB_ENV
            echo "CURRENT_ARIA2=$(jq -r '.aria2_version // "none"' update.json)" >> $GITHUB_ENV
            echo "CURRENT_QBIT=$(jq -r '.qbit_version // "none"' update.json)" >> $GITHUB_ENV
            echo "CURRENT_FRPC=$(jq -r '.frpc_version // "none"' update.json)" >> $GITHUB_ENV
            echo "CURRENT_RCLONE=$(jq -r '.rclone_version // "none"' update.json)" >> $GITHUB_ENV
            echo "CURRENT_ARIANG=$(jq -r '.ariang_version // "none"' update.json)" >> $GITHUB_ENV
            echo "CURRENT_VUETORRENT=$(jq -r '.vuetorrent_version // "none"' update.json)" >> $GITHUB_ENV
            cat update.json
          else
            echo "update.json ä¸å­˜åœ¨ï¼Œå°†è¿›è¡Œé¦–æ¬¡æž„å»º"
            echo "CURRENT_OPENLIST=none" >> $GITHUB_ENV
            echo "CURRENT_ARIA2=none" >> $GITHUB_ENV
            echo "CURRENT_QBIT=none" >> $GITHUB_ENV
            echo "CURRENT_FRPC=none" >> $GITHUB_ENV
            echo "CURRENT_RCLONE=none" >> $GITHUB_ENV
            echo "CURRENT_ARIANG=none" >> $GITHUB_ENV
            echo "CURRENT_VUETORRENT=none" >> $GITHUB_ENV
          fi
          echo "::endgroup::"

      - name: åˆ¤æ–­æ˜¯å¦éœ€è¦æž„å»º
        id: should_build
        run: |
          echo "::group::ç‰ˆæœ¬å¯¹æ¯”"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ç»„ä»¶           å½“å‰ç‰ˆæœ¬          æœ€æ–°ç‰ˆæœ¬"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "OpenList       ${{ env.CURRENT_OPENLIST }}    â†’    ${{ env.OPENLIST_VERSION }}"
          echo "Aria2          ${{ env.CURRENT_ARIA2 }}    â†’    ${{ env.ARIA2_VERSION }}"
          echo "Qbittorrent    ${{ env.CURRENT_QBIT }}    â†’    ${{ env.QBIT_VERSION }}"
          echo "Frpc           ${{ env.CURRENT_FRPC }}    â†’    ${{ env.FRPC_VERSION }}"
          echo "Rclone         ${{ env.CURRENT_RCLONE }}    â†’    ${{ env.RCLONE_VERSION }}"
          echo "AriaNg         ${{ env.CURRENT_ARIANG }}    â†’    ${{ env.ARIANG_VERSION }}"
          echo "VueTorrent     ${{ env.CURRENT_VUETORRENT }}    â†’    ${{ env.VUETORRENT_VERSION }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          SHOULD_BUILD="false"
          BUILD_REASON=""
          
          if [ "${{ github.event.inputs.force_build }}" = "true" ]; then
            SHOULD_BUILD="true"
            BUILD_REASON="æ‰‹åŠ¨å¼ºåˆ¶æž„å»º"
          elif [ "${{ env.OPENLIST_VERSION }}" != "${{ env.CURRENT_OPENLIST }}" ]; then
            SHOULD_BUILD="true"
            BUILD_REASON="OpenList æ›´æ–°: ${{ env.CURRENT_OPENLIST }} â†’ ${{ env.OPENLIST_VERSION }}"
          elif [ "${{ env.ARIA2_VERSION }}" != "${{ env.CURRENT_ARIA2 }}" ]; then
            SHOULD_BUILD="true"
            BUILD_REASON="Aria2 æ›´æ–°: ${{ env.CURRENT_ARIA2 }} â†’ ${{ env.ARIA2_VERSION }}"
          elif [ "${{ env.QBIT_VERSION }}" != "${{ env.CURRENT_QBIT }}" ]; then
            SHOULD_BUILD="true"
            BUILD_REASON="Qbittorrent æ›´æ–°: ${{ env.CURRENT_QBIT }} â†’ ${{ env.QBIT_VERSION }}"
          elif [ "${{ env.FRPC_VERSION }}" != "${{ env.CURRENT_FRPC }}" ]; then
            SHOULD_BUILD="true"
            BUILD_REASON="Frpc æ›´æ–°: ${{ env.CURRENT_FRPC }} â†’ ${{ env.FRPC_VERSION }}"
          elif [ "${{ env.RCLONE_VERSION }}" != "${{ env.CURRENT_RCLONE }}" ]; then
            SHOULD_BUILD="true"
            BUILD_REASON="Rclone æ›´æ–°: ${{ env.CURRENT_RCLONE }} â†’ ${{ env.RCLONE_VERSION }}"
          elif [ "${{ env.ARIANG_VERSION }}" != "${{ env.CURRENT_ARIANG }}" ]; then
            SHOULD_BUILD="true"
            BUILD_REASON="AriaNg æ›´æ–°: ${{ env.CURRENT_ARIANG }} â†’ ${{ env.ARIANG_VERSION }}"
          elif [ "${{ env.VUETORRENT_VERSION }}" != "${{ env.CURRENT_VUETORRENT }}" ]; then
            SHOULD_BUILD="true"
            BUILD_REASON="VueTorrent æ›´æ–°: ${{ env.CURRENT_VUETORRENT }} â†’ ${{ env.VUETORRENT_VERSION }}"
          fi
          
          echo ""
          if [ "$SHOULD_BUILD" = "true" ]; then
            echo "âœ… éœ€è¦æž„å»º: $BUILD_REASON"
          else
            echo "â­ï¸ æ— éœ€æž„å»º: æ‰€æœ‰ç»„ä»¶å‡ä¸ºæœ€æ–°ç‰ˆæœ¬"
          fi
          
          echo "SHOULD_BUILD=$SHOULD_BUILD" >> $GITHUB_ENV
          echo "BUILD_REASON=$BUILD_REASON" >> $GITHUB_ENV
          echo "::endgroup::"

      # ================================================================
      # ç¬¬ä¸‰é˜¶æ®µï¼šä¸‹è½½ä¸Žç»„è£…
      # ================================================================
      
      - name: ä¸‹è½½ OpenList
        if: env.SHOULD_BUILD == 'true'
        run: |
          echo "::group::ä¸‹è½½ OpenList"
          mkdir -p downloads
          
          echo "ä¸‹è½½ ARM ç‰ˆæœ¬..."
          curl -L -o downloads/openlist-arm.tar.gz "${{ env.OPENLIST_ARM_URL }}"
          
          echo "ä¸‹è½½ ARM64 ç‰ˆæœ¬..."
          curl -L -o downloads/openlist-arm64.tar.gz "${{ env.OPENLIST_ARM64_URL }}"
          
          ls -la downloads/
          echo "::endgroup::"

      - name: ä¸‹è½½é™„åŠ ç»„ä»¶
        if: env.SHOULD_BUILD == 'true'
        run: |
          echo "::group::ä¸‹è½½é™„åŠ ç»„ä»¶"
          mkdir -p downloads
          
          echo "ä¸‹è½½ Aria2..."
          curl -L -o downloads/aria2.tar.gz "${{ env.ARIA2_URL }}"
          
          echo "ä¸‹è½½ Qbittorrent..."
          curl -L -o downloads/qbittorrent-nox "${{ env.QBIT_URL }}"
          
          echo "ä¸‹è½½ Frpc..."
          curl -L -o downloads/frp.tar.gz "${{ env.FRPC_URL }}"
          
          echo "ä¸‹è½½ Rclone..."
          curl -L -o downloads/rclone.zip "${{ env.RCLONE_URL }}"
          
          echo "ä¸‹è½½ AriaNg..."
          curl -L -o downloads/ariang.zip "${{ env.ARIANG_URL }}"
          
          echo "ä¸‹è½½ VueTorrent..."
          curl -L -o downloads/vuetorrent.zip "${{ env.VUETORRENT_URL }}"
          
          ls -la downloads/
          echo "::endgroup::"

      - name: ç»„è£…æ¨¡å—æ–‡ä»¶
        if: env.SHOULD_BUILD == 'true'
        run: |
          echo "::group::ç»„è£…æ¨¡å—"
          
          mkdir -p OpenList-Magisk/bin
          mkdir -p OpenList-Magisk/web/ariang
          mkdir -p OpenList-Magisk/web/vuetorrent
          
          echo "å¤„ç† OpenList ARM..."
          tar -xzf downloads/openlist-arm.tar.gz -C downloads/
          mv downloads/openlist OpenList-Magisk/openlist-arm
          
          echo "å¤„ç† OpenList ARM64..."
          tar -xzf downloads/openlist-arm64.tar.gz -C downloads/
          mv downloads/openlist OpenList-Magisk/openlist-arm64
          
          echo "å¤„ç† Aria2..."
          tar -xzf downloads/aria2.tar.gz -C downloads/
          find downloads -name "aria2c" -type f -exec mv {} OpenList-Magisk/bin/aria2c \;
          
          echo "å¤„ç† Qbittorrent..."
          mv downloads/qbittorrent-nox OpenList-Magisk/bin/qbittorrent-nox
          
          echo "å¤„ç† Frpc..."
          tar -xzf downloads/frp.tar.gz -C downloads/
          find downloads -name "frpc" -type f -exec mv {} OpenList-Magisk/bin/frpc \;
          
          echo "å¤„ç† Rclone..."
          unzip -o downloads/rclone.zip -d downloads/rclone_tmp
          find downloads/rclone_tmp -name "rclone" -type f -exec mv {} OpenList-Magisk/bin/rclone \;
          
          echo "å¤„ç† AriaNg..."
          unzip -o downloads/ariang.zip -d OpenList-Magisk/web/ariang
          
          echo "å¤„ç† VueTorrent..."
          unzip -o downloads/vuetorrent.zip -d downloads/vuetorrent_tmp
          if [ -d "downloads/vuetorrent_tmp/vuetorrent" ]; then
            mv downloads/vuetorrent_tmp/vuetorrent/* OpenList-Magisk/web/vuetorrent/
          else
            mv downloads/vuetorrent_tmp/* OpenList-Magisk/web/vuetorrent/
          fi
          
          echo "è®¾ç½®æ‰§è¡Œæƒé™..."
          chmod 755 OpenList-Magisk/openlist-*
          chmod 755 OpenList-Magisk/bin/*
          
          rm -rf downloads
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "æ¨¡å—æ–‡ä»¶ç»“æž„:"
          find OpenList-Magisk -type f | head -50
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "::endgroup::"

      # ================================================================
      # ç¬¬å››é˜¶æ®µï¼šæ›´æ–°é…ç½®ä¸Žå‘å¸ƒ
      # ================================================================
      
      - name: æ›´æ–° module.prop
        if: env.SHOULD_BUILD == 'true'
        run: |
          echo "::group::æ›´æ–° module.prop"
          
          if [ -f OpenList-Magisk/module.prop ]; then
            sed -i "s/^version=.*/version=${{ env.OPENLIST_VERSION }} (All-in-One)/" OpenList-Magisk/module.prop
            sed -i "s/^versionCode=.*/versionCode=${{ env.OPENLIST_VERSION_CODE }}/" OpenList-Magisk/module.prop
            
            echo "æ›´æ–°åŽçš„ module.prop:"
            cat OpenList-Magisk/module.prop
          else
            echo "::error::module.prop æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          echo "::endgroup::"

      - name: æ›´æ–° update.json
        if: env.SHOULD_BUILD == 'true'
        run: |
          echo "::group::æ›´æ–° update.json"
          
          CHANGELOG_SUMMARY="OpenList ${{ env.OPENLIST_VERSION }}"
          [ "${{ env.ARIA2_VERSION }}" != "${{ env.CURRENT_ARIA2 }}" ] && CHANGELOG_SUMMARY="$CHANGELOG_SUMMARY | Aria2 ${{ env.ARIA2_VERSION }}"
          [ "${{ env.QBIT_VERSION }}" != "${{ env.CURRENT_QBIT }}" ] && CHANGELOG_SUMMARY="$CHANGELOG_SUMMARY | QB ${{ env.QBIT_VERSION }}"
          [ "${{ env.FRPC_VERSION }}" != "${{ env.CURRENT_FRPC }}" ] && CHANGELOG_SUMMARY="$CHANGELOG_SUMMARY | Frpc ${{ env.FRPC_VERSION }}"
          
          cat > update.json << EOF
          {
            "version": "${{ env.OPENLIST_VERSION }}",
            "versionCode": ${{ env.OPENLIST_VERSION_CODE }},
            "zipUrl": "${{ github.server_url }}/${{ github.repository }}/releases/download/${{ env.OPENLIST_VERSION }}/openlist-magisk-${{ env.OPENLIST_VERSION }}.zip",
            "changelog": "${{ github.server_url }}/${{ github.repository }}/raw/main/CHANGELOG.md",
            "aria2_version": "${{ env.ARIA2_VERSION }}",
            "qbit_version": "${{ env.QBIT_VERSION }}",
            "frpc_version": "${{ env.FRPC_VERSION }}",
            "rclone_version": "${{ env.RCLONE_VERSION }}",
            "ariang_version": "${{ env.ARIANG_VERSION }}",
            "vuetorrent_version": "${{ env.VUETORRENT_VERSION }}",
            "build_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "build_reason": "${{ env.BUILD_REASON }}"
          }
          EOF
          
          echo "ç”Ÿæˆçš„ update.json:"
          cat update.json
          echo "::endgroup::"

      - name: æ‰“åŒ…æ¨¡å—
        if: env.SHOULD_BUILD == 'true'
        run: |
          echo "::group::æ‰“åŒ… Magisk æ¨¡å—"
          
          cd OpenList-Magisk
          
          zip -r ../openlist-magisk-${{ env.OPENLIST_VERSION }}.zip . \
            -x "*.git*" \
            -x "*.md" \
            -x "*.txt"
          
          cd ..
          
          echo "æ‰“åŒ…å®Œæˆ:"
          ls -lh openlist-magisk-${{ env.OPENLIST_VERSION }}.zip
          echo "::endgroup::"

      - name: æäº¤é…ç½®æ›´æ–°
        if: env.SHOULD_BUILD == 'true'
        run: |
          echo "::group::æäº¤æ›´æ–°åˆ°ä»“åº“"
          
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          git add update.json OpenList-Magisk/module.prop
          
          COMMIT_MSG="ðŸš€ Auto update: ${{ env.BUILD_REASON }}"
          git commit -m "$COMMIT_MSG" || echo "æ— æ›´æ”¹éœ€è¦æäº¤"
          git push origin main
          
          echo "::endgroup::"

      - name: ç”Ÿæˆ Release Notes
        if: env.SHOULD_BUILD == 'true'
        run: |
          BUILD_TIME=$(date -u +"%Y-%m-%d %H:%M:%S")
          cat > release_notes.md << EOF
          ## ðŸ“¦ OpenList All-in-One Magisk Module
          
          **æ”¯æŒæ¡†æž¶**: Magisk / KernelSU / APatch
          
          ### ðŸ“‹ ç»„ä»¶ç‰ˆæœ¬
          | ç»„ä»¶ | ç‰ˆæœ¬ |
          |------|------|
          | OpenList | ${{ env.OPENLIST_VERSION }} |
          | Aria2 | ${{ env.ARIA2_VERSION }} |
          | Qbittorrent | ${{ env.QBIT_VERSION }} |
          | Frpc | ${{ env.FRPC_VERSION }} |
          | Rclone | ${{ env.RCLONE_VERSION }} |
          | AriaNg | ${{ env.ARIANG_VERSION }} |
          | VueTorrent | ${{ env.VUETORRENT_VERSION }} |
          
          ### ðŸ”„ æœ¬æ¬¡æ›´æ–°
          ${{ env.BUILD_REASON }}
          
          ### ðŸ“– ä½¿ç”¨è¯´æ˜Ž
          1. ä¸‹è½½ zip æ–‡ä»¶
          2. åœ¨ Magisk/KernelSU/APatch ä¸­å®‰è£…æ¨¡å—
          3. æŒ‰æç¤ºé€‰æ‹©å®‰è£…è·¯å¾„
          4. é‡å¯è®¾å¤‡
          
          ### ðŸ”— é»˜è®¤ç«¯å£
          - OpenList: \`5244\`
          - Aria2 RPC: \`6800\` (å¯†é’¥: \`openlist\`)
          - Qbittorrent: \`8080\` (admin/adminadmin)
          
          ---
          > è‡ªåŠ¨æž„å»ºäºŽ ${BUILD_TIME} UTC
          EOF

      - name: æ£€æŸ¥æ˜¯å¦å­˜åœ¨ç›¸åŒ Tag
        if: env.SHOULD_BUILD == 'true'
        id: check_tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if gh release view "${{ env.OPENLIST_VERSION }}" > /dev/null 2>&1; then
            echo "TAG_EXISTS=true" >> $GITHUB_ENV
            echo "âš ï¸ Release ${{ env.OPENLIST_VERSION }} å·²å­˜åœ¨ï¼Œå°†æ›´æ–°èµ„äº§"
          else
            echo "TAG_EXISTS=false" >> $GITHUB_ENV
            echo "âœ… å°†åˆ›å»ºæ–° Release: ${{ env.OPENLIST_VERSION }}"
          fi

      - name: æ›´æ–°å·²å­˜åœ¨çš„ Release
        if: env.SHOULD_BUILD == 'true' && env.TAG_EXISTS == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "åˆ é™¤æ—§èµ„äº§..."
          gh release delete-asset "${{ env.OPENLIST_VERSION }}" \
            "openlist-magisk-${{ env.OPENLIST_VERSION }}.zip" --yes || true
          
          echo "ä¸Šä¼ æ–°èµ„äº§..."
          gh release upload "${{ env.OPENLIST_VERSION }}" \
            "openlist-magisk-${{ env.OPENLIST_VERSION }}.zip" --clobber
          
          echo "æ›´æ–° Release Notes..."
          gh release edit "${{ env.OPENLIST_VERSION }}" \
            --notes-file release_notes.md

      - name: åˆ›å»ºæ–° Release
        if: env.SHOULD_BUILD == 'true' && env.TAG_EXISTS == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ env.OPENLIST_VERSION }}" \
            --title "OpenList ${{ env.OPENLIST_VERSION }} (All-in-One)" \
            --notes-file release_notes.md \
            --draft=false \
            --prerelease=false \
            "openlist-magisk-${{ env.OPENLIST_VERSION }}.zip"

      # ================================================================
      # æ¸…ç†æ—§ç‰ˆæœ¬ Releaseï¼ˆæ–°å¢žï¼‰
      # ================================================================
      
      - name: æ¸…ç†æ—§ç‰ˆæœ¬ Release
        if: env.SHOULD_BUILD == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "::group::æ¸…ç†æ—§ç‰ˆæœ¬ Release"
          
          # èŽ·å–æ‰€æœ‰ release çš„ tagï¼ˆæŒ‰æ—¶é—´æŽ’åºï¼Œæœ€æ–°åœ¨å‰ï¼‰
          RELEASES=$(gh release list --limit 100 --json tagName --jq '.[].tagName')
          
          COUNT=0
          KEEP=1  # åªä¿ç•™æœ€æ–°çš„ 1 ä¸ªç‰ˆæœ¬
          
          for TAG in $RELEASES; do
            COUNT=$((COUNT + 1))
            
            if [ $COUNT -gt $KEEP ]; then
              echo "ðŸ—‘ï¸ åˆ é™¤æ—§ç‰ˆæœ¬: $TAG"
              gh release delete "$TAG" --yes --cleanup-tag || true
            else
              echo "âœ… ä¿ç•™æœ€æ–°ç‰ˆæœ¬: $TAG"
            fi
          done
          
          echo ""
          echo "æ¸…ç†å®Œæˆï¼Œä¿ç•™äº† $KEEP ä¸ªæœ€æ–°ç‰ˆæœ¬"
          echo "::endgroup::"

      # ================================================================
      # æ¸…ç†é˜¶æ®µ
      # ================================================================
      
      - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if: always()
        run: |
          rm -rf openlist-magisk-*.zip release_notes.md downloads/

      - name: æž„å»ºæ‘˜è¦
        if: always()
        run: |
          echo "## ðŸ—ï¸ æž„å»ºæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ env.SHOULD_BUILD }}" = "true" ]; then
            echo "âœ… **æž„å»ºæˆåŠŸ**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**æž„å»ºåŽŸå› **: ${{ env.BUILD_REASON }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ç»„ä»¶ç‰ˆæœ¬" >> $GITHUB_STEP_SUMMARY
            echo "| ç»„ä»¶ | ç‰ˆæœ¬ |" >> $GITHUB_STEP_SUMMARY
            echo "|------|------|" >> $GITHUB_STEP_SUMMARY
            echo "| OpenList | ${{ env.OPENLIST_VERSION }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Aria2 | ${{ env.ARIA2_VERSION }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Qbittorrent | ${{ env.QBIT_VERSION }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Frpc | ${{ env.FRPC_VERSION }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Rclone | ${{ env.RCLONE_VERSION }} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "â­ï¸ **è·³è¿‡æž„å»º**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "æ‰€æœ‰ç»„ä»¶å‡ä¸ºæœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°ã€‚" >> $GITHUB_STEP_SUMMARY
          fi
